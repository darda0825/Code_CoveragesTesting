import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Resolve __dirname for ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Directories
const jsonResultsDir = path.join(__dirname, '..', 'json-results');
const reportHtmlFile = path.join(__dirname, '..', 'html-report', 'index.html');

let passed = 0;
let failed = 0;

// Read all JSON files and aggregate results
const files = fs.readdirSync(jsonResultsDir);
for (const file of files) {
  const filePath = path.join(jsonResultsDir, file);
  if (file.endsWith('.json') && fs.statSync(filePath).isFile()) {
    const content = fs.readFileSync(filePath, 'utf-8');
    const json = JSON.parse(content);

    if (Array.isArray(json.suites)) {
      for (const suite of json.suites) {
        for (const spec of suite.specs ?? []) {
          for (const test of spec.tests ?? []) {
            for (const result of test.results ?? []) {
              if (result.status === 'passed') passed++;
              else if (result.status === 'failed') failed++;
            }
          }
        }
      }
    }
  }
}

// Check report file exists
if (!fs.existsSync(reportHtmlFile)) {
  console.error('❌ Merged HTML report not found!');
  process.exit(1);
}

// Read original report
let html = fs.readFileSync(reportHtmlFile, 'utf-8');

// Inject pie chart before </body>
const pieChartHTML = `
  <div style="width: 400px; margin: 20px auto;">
    <h2 style="text-align: center;">Test Result Summary</h2>
    <canvas id="resultPieChart" width="400" height="400"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const ctx = document.getElementById('resultPieChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Passed', 'Failed'],
          datasets: [{
            label: 'Test Results',
            data: [${passed}, ${failed}],
            backgroundColor: ['#4CAF50', '#F44336'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    </script>
  </div>
`;

html = html.replace('</body>', `${pieChartHTML}\n</body>`);
fs.writeFileSync(reportHtmlFile, html, 'utf-8');
console.log(`✅ Pie chart added to HTML report. Passed: ${passed}, Failed: ${failed}`);
